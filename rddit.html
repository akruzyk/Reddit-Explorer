<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Community Explorer - React</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .text-shadow-lg {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .category-card {
            transition: all 0.3s ease;
        }
        
        .category-card:hover {
            transform: translateY(-2px);
        }
        
        .community-card {
            transition: all 0.3s ease;
        }
        
        .community-card:hover {
            transform: translateX(8px);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const RedditExplorer = () => {
            // State management
            const [communities, setCommunities] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [currentTier, setCurrentTier] = useState('all');
            const [currentCategory, setCurrentCategory] = useState('all');
            const [currentPage, setCurrentPage] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            const [searchMode, setSearchMode] = useState('all');
            const [sortBy, setSortBy] = useState('subscribers');
            const [nsfwOnly, setNsfwOnly] = useState(false);
            const [isCompact, setIsCompact] = useState(false);
            const [categoryView, setCategoryView] = useState('cards');
            const [pagination, setPagination] = useState({});
            const [stats, setStats] = useState({
                total: 0,
                total_subscribers: 0,
                avg_subscribers: 0
            });
            const [expandedCards, setExpandedCards] = useState(new Set());

            const API_BASE = 'http://localhost:5000/api';

            // Categories data
            const categories = [
                { id: 'all', name: 'All Communities', icon: '🌐', description: 'Browse all available communities', count: 0 },
                { id: 'discussion', name: 'Discussion & Conversation', icon: '💬', description: 'Communities focused on discussion and conversation', count: 0 },
                { id: 'humor', name: 'Humor & Memes', icon: '😂', description: 'Funny content, memes, and comedy', count: 0 },
                { id: 'gaming', name: 'Gaming', icon: '🎮', description: 'Video games, gaming news, and gaming communities', count: 0 },
                { id: 'technology', name: 'Technology', icon: '💻', description: 'Tech news, programming, and technology discussions', count: 0 },
                { id: 'images', name: 'Images & Photography', icon: '📸', description: 'Photo sharing, art, and visual content', count: 0 },
                { id: 'news', name: 'News & World Events', icon: '📰', description: 'Current events, news, and world happenings', count: 0 },
                { id: 'creative', name: 'Creative & Arts', icon: '🎨', description: 'Art, music, writing, and creative works', count: 0 },
                { id: 'support', name: 'Support Communities', icon: '🤝', description: 'Support groups and helpful communities', count: 0 },
                { id: 'nsfw', name: 'NSFW Content', icon: '🔞', description: 'Adult content and NSFW communities', count: 0 }
            ];

            // Utility functions
            const formatNumber = (num) => {
                if (!num) return '0';
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            };

            const formatDate = (dateString) => {
                if (!dateString) return 'Unknown date';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                } catch (e) {
                    return dateString;
                }
            };

            const getYearsAgo = (dateString) => {
                if (!dateString) return 0;
                try {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffTime = Math.abs(now - date);
                    return Math.floor(diffTime / (1000 * 60 * 60 * 24 * 365.25));
                } catch (e) {
                    return 0;
                }
            };

            const getSubredditTags = (community) => {
                const tags = [];
                const name = (community.display_name || '').toLowerCase();
                const description = (community.public_description || community.description || '').toLowerCase();
                
                if (community.over18 || name.includes('nsfw') || description.includes('nsfw')) {
                    tags.push({ name: 'nsfw', color: 'bg-red-500' });
                }
                if (name.includes('gaming') || name.includes('game') || description.includes('game')) {
                    tags.push({ name: 'gaming', color: 'bg-green-500' });
                }
                if (name.includes('tech') || name.includes('programming') || name.includes('code') || description.includes('technology')) {
                    tags.push({ name: 'tech', color: 'bg-blue-500' });
                }
                if (name.includes('ask') || name.includes('discussion') || description.includes('discuss')) {
                    tags.push({ name: 'discussion', color: 'bg-purple-500' });
                }
                
                return tags;
            };

            // API functions
            const loadData = useCallback(async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const url = new URL(`${API_BASE}/communities`);
                    url.searchParams.set('tier', currentTier);
                    url.searchParams.set('search', searchTerm);
                    url.searchParams.set('mode', searchMode);
                    url.searchParams.set('sort', sortBy);
                    url.searchParams.set('page', currentPage);
                    url.searchParams.set('per_page', 50);
                    
                    if (nsfwOnly) {
                        url.searchParams.set('nsfw_only', 'true');
                    }

                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    setCommunities(data.data || []);
                    setPagination(data.pagination || {});

                } catch (err) {
                    console.error('Error loading data:', err);
                    setError(err.message || 'Failed to load data. Make sure the server is running.');
                    setCommunities([]);
                } finally {
                    setLoading(false);
                }
            }, [currentTier, searchTerm, searchMode, sortBy, currentPage, nsfwOnly]);

            const loadStats = useCallback(async () => {
                try {
                    const url = new URL(`${API_BASE}/stats`);
                    url.searchParams.set('tier', currentTier);
                    
                    if (nsfwOnly) {
                        url.searchParams.set('nsfw_only', 'true');
                    }
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Stats error: ${response.status}`);
                    }
                    
                    const statsData = await response.json();
                    
                    if (!statsData.error) {
                        setStats(statsData);
                    }
                } catch (err) {
                    console.error('Error loading stats:', err);
                }
            }, [currentTier, nsfwOnly]);

            // Event handlers
            const handleTierChange = (tier) => {
                setCurrentTier(tier);
                setCurrentPage(1);
            };

            const handleCategoryChange = (categoryId) => {
                setCurrentCategory(categoryId);
                setCurrentPage(1);
            };

            const handleNsfwToggle = () => {
                setNsfwOnly(!nsfwOnly);
                setCurrentPage(1);
            };

            const handleSearchChange = (value) => {
                setSearchTerm(value);
                setCurrentPage(1);
            };

            const handlePageChange = (page) => {
                setCurrentPage(page);
                window.scrollTo(0, 0);
            };

            const toggleCardExpansion = (index) => {
                const newExpanded = new Set(expandedCards);
                if (newExpanded.has(index)) {
                    newExpanded.delete(index);
                } else {
                    newExpanded.add(index);
                }
                setExpandedCards(newExpanded);
            };

            // Effects
            useEffect(() => {
                loadData();
            }, [loadData]);

            useEffect(() => {
                loadStats();
            }, [loadStats]);

            // Debounced search effect
            useEffect(() => {
                const timeoutId = setTimeout(() => {
                    if (searchTerm !== '') {
                        loadData();
                    }
                }, 300);
                return () => clearTimeout(timeoutId);
            }, [searchTerm, loadData]);

            // Components
            const CategoryCard = ({ category, isActive, onClick }) => (
                <div
                    className={`category-card p-5 rounded-xl cursor-pointer transition-all duration-300 ${
                        isActive 
                            ? 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white border-2 border-indigo-500' 
                            : 'bg-gradient-to-br from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-200 border-2 border-transparent hover:border-indigo-500'
                    } hover:transform hover:-translate-y-1 hover:shadow-lg`}
                    onClick={onClick}
                >
                    <span className="text-2xl mb-3 block">{category.icon}</span>
                    <div className="text-lg font-semibold mb-1">{category.name}</div>
                    <div className={`text-sm mb-2 ${isActive ? 'opacity-90' : 'opacity-70'}`}>
                        {category.count.toLocaleString()} communities
                    </div>
                    <div className={`text-xs leading-tight ${isActive ? 'opacity-80' : 'opacity-60'}`}>
                        {category.description}
                    </div>
                </div>
            );

            const CommunityCard = ({ community, index, isExpanded, onToggle, isCompact }) => {
                const tags = getSubredditTags(community);
                
                return (
                    <div
                        className={`community-card bg-white p-5 transition-all duration-300 cursor-pointer border-l-4 border-transparent hover:border-indigo-500 hover:bg-gray-50 hover:transform hover:translate-x-2 ${
                            isCompact ? 'p-3' : 'p-5'
                        }`}
                        onClick={(e) => {
                            if (!e.target.closest('.community-link')) {
                                onToggle(index);
                            }
                        }}
                    >
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3 flex-1">
                                <a
                                    href={`https://reddit.com${community.url || ''}`}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="community-link text-indigo-600 hover:text-indigo-800 font-bold text-lg hover:underline"
                                    onClick={(e) => e.stopPropagation()}
                                >
                                    {community.display_name || 'Unknown'}
                                </a>
                                <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                    {formatNumber(community.subscribers || 0)}
                                </span>
                            </div>
                            <span className={`text-gray-400 transition-transform duration-200 ${
                                isExpanded ? 'transform rotate-180' : ''
                            }`}>
                                ▼
                            </span>
                        </div>

                        {tags.length > 0 && (
                            <div className="flex gap-2 mt-2 flex-wrap">
                                {tags.map((tag, idx) => (
                                    <span key={idx} className={`${tag.color} text-white px-2 py-1 rounded text-xs font-medium`}>
                                        {tag.name.toUpperCase()}
                                    </span>
                                ))}
                            </div>
                        )}

                        {!isCompact && (
                            <div className="flex items-center gap-4 mt-3 text-sm text-gray-600">
                                <div className="flex items-center gap-1">
                                    📅 {formatDate(community.created_date)} ({getYearsAgo(community.created_date)} years ago)
                                </div>
                            </div>
                        )}

                        {isExpanded && (
                            <div className="mt-4 text-gray-700 leading-relaxed border-t pt-3">
                                {community.public_description || community.description || 'No description available'}
                            </div>
                        )}
                    </div>
                );
            };

            const Pagination = ({ pagination }) => {
                if (!pagination || pagination.total_pages <= 1) return null;

                const { page, total_pages } = pagination;
                const startPage = Math.max(1, page - 2);
                const endPage = Math.min(total_pages, startPage + 4);

                return (
                    <div className="flex justify-center gap-2 my-5">
                        {page > 1 && (
                            <button
                                onClick={() => handlePageChange(page - 1)}
                                className="px-4 py-2 border border-gray-300 rounded-md bg-white hover:bg-gray-50"
                            >
                                ←
                            </button>
                        )}
                        
                        {Array.from({ length: endPage - startPage + 1 }, (_, i) => startPage + i).map(pageNum => (
                            <button
                                key={pageNum}
                                onClick={() => handlePageChange(pageNum)}
                                className={`px-4 py-2 border rounded-md ${
                                    pageNum === page
                                        ? 'bg-indigo-600 text-white border-indigo-600'
                                        : 'bg-white border-gray-300 hover:bg-gray-50'
                                }`}
                            >
                                {pageNum}
                            </button>
                        ))}
                        
                        {page < total_pages && (
                            <button
                                onClick={() => handlePageChange(page + 1)}
                                className="px-4 py-2 border border-gray-300 rounded-md bg-white hover:bg-gray-50"
                            >
                                →
                            </button>
                        )}
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600">
                    <div className="max-w-7xl mx-auto px-5 py-8">
                        {/* Header */}
                        <div className="text-center mb-10 text-white">
                            <h1 className="text-5xl font-bold mb-3 text-shadow-lg">🚀 Reddit Community Explorer</h1>
                            <p className="text-xl opacity-90">Discover and explore Reddit's most popular communities</p>
                        </div>

                        {/* Controls */}
                        <div className="bg-white bg-opacity-95 rounded-2xl p-8 mb-8 backdrop-blur-sm shadow-xl">
                            {/* NSFW Toggle */}
                            <div className="flex items-center gap-3 p-4 bg-red-50 border-2 border-red-200 rounded-lg mb-6">
                                <input
                                    type="checkbox"
                                    id="nsfwOnly"
                                    checked={nsfwOnly}
                                    onChange={handleNsfwToggle}
                                    className="w-5 h-5 text-red-600"
                                />
                                <label htmlFor="nsfwOnly" className="font-semibold text-red-700 cursor-pointer">
                                    Show ONLY NSFW Content
                                </label>
                            </div>

                            {/* Category Cards */}
                            <div className="mb-8">
                                <div className="flex justify-between items-center mb-5">
                                    <h3 className="text-xl font-semibold text-gray-700">Browse by Category</h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setCategoryView('cards')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                                categoryView === 'cards'
                                                    ? 'bg-indigo-600 text-white'
                                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }`}
                                        >
                                            📱 Cards
                                        </button>
                                        <button
                                            onClick={() => setCategoryView('list')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                                categoryView === 'list'
                                                    ? 'bg-indigo-600 text-white'
                                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }`}
                                        >
                                            📋 List
                                        </button>
                                    </div>
                                </div>
                                
                                <div className={`grid gap-4 ${
                                    categoryView === 'cards' 
                                        ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5' 
                                        : 'grid-cols-1'
                                }`}>
                                    {categories.map(category => (
                                        <CategoryCard
                                            key={category.id}
                                            category={category}
                                            isActive={currentCategory === category.id}
                                            onClick={() => handleCategoryChange(category.id)}
                                        />
                                    ))}
                                </div>
                            </div>

                            {/* Tier Selector */}
                            <div className="flex gap-3 mb-6 flex-wrap justify-center">
                                {[
                                    { id: 'all', name: 'All Communities' },
                                    { id: 'major', name: 'Major (1M+)' },
                                    { id: 'rising', name: 'Rising (100k-999k)' },
                                    { id: 'growing', name: 'Growing (10k-99k)' },
                                    { id: 'emerging', name: 'Emerging (1k-9.9k)' }
                                ].map(tier => (
                                    <button
                                        key={tier.id}
                                        onClick={() => handleTierChange(tier.id)}
                                        className={`px-6 py-3 rounded-full font-semibold transition-all transform ${
                                            currentTier === tier.id
                                                ? 'bg-indigo-600 text-white shadow-lg scale-105'
                                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                        }`}
                                    >
                                        {tier.name}
                                    </button>
                                ))}
                            </div>

                            {/* Search and Controls */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="relative">
                                    <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">🔍</span>
                                    <input
                                        type="text"
                                        placeholder="Search communities..."
                                        value={searchTerm}
                                        onChange={(e) => handleSearchChange(e.target.value)}
                                        className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors"
                                    />
                                </div>

                                <select
                                    value={searchMode}
                                    onChange={(e) => setSearchMode(e.target.value)}
                                    className="px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors"
                                >
                                    <option value="all">Name & Description</option>
                                    <option value="name">Name Only</option>
                                    <option value="description">Description Only</option>
                                </select>

                                <select
                                    value={sortBy}
                                    onChange={(e) => setSortBy(e.target.value)}
                                    className="px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors"
                                >
                                    <option value="subscribers">Subscribers (High to Low)</option>
                                    <option value="subscribers_asc">Subscribers (Low to High)</option>
                                    <option value="name">Name (A-Z)</option>
                                    <option value="name_desc">Name (Z-A)</option>
                                    <option value="created">Newest First</option>
                                    <option value="created_desc">Oldest First</option>
                                </select>
                            </div>

                            {/* Stats */}
                            <div className="flex gap-6 justify-center flex-wrap">
                                {[
                                    { label: 'Communities Shown', value: formatNumber(stats.total), icon: '🏘️' },
                                    { label: 'Total Subscribers', value: formatNumber(stats.total_subscribers), icon: '👥' },
                                    { label: 'Avg Subscribers', value: formatNumber(stats.avg_subscribers), icon: '📊' }
                                ].map((stat, idx) => (
                                    <div key={idx} className="text-center bg-white rounded-xl p-4 shadow-md min-w-32">
                                        <div className="text-2xl mb-1">{stat.icon}</div>
                                        <div className="text-2xl font-bold text-indigo-600">{stat.value}</div>
                                        <div className="text-sm text-gray-600">{stat.label}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Results */}
                        <div className="bg-white bg-opacity-95 rounded-2xl overflow-hidden shadow-xl backdrop-blur-sm">
                            <div className="bg-indigo-600 text-white p-6">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <h2 className="text-2xl font-bold">Communities</h2>
                                        {pagination.total && (
                                            <p className="opacity-90 mt-1">
                                                Showing {((pagination.page - 1) * pagination.per_page) + 1}-
                                                {Math.min(pagination.page * pagination.per_page, pagination.total)} of {pagination.total.toLocaleString()} subreddits
                                            </p>
                                        )}
                                    </div>
                                    <button
                                        onClick={() => setIsCompact(!isCompact)}
                                        className="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-all font-medium"
                                    >
                                        {isCompact ? 'Expanded View' : 'Compact View'}
                                    </button>
                                </div>
                            </div>

                            {/* Content */}
                            <div className="divide-y divide-gray-100">
                                {loading ? (
                                    <div className="text-center py-12 text-indigo-600 text-xl">
                                        <div className="inline-block w-8 h-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite] mb-3"></div>
                                        <div>Loading communities...</div>
                                    </div>
                                ) : error ? (
                                    <div className="text-center py-12 text-red-600 text-xl">
                                        ❌ {error}
                                    </div>
                                ) : communities.length === 0 ? (
                                    <div className="text-center py-12 text-gray-600">
                                        <h3 className="text-xl font-semibold mb-2">No communities found</h3>
                                        <p>Try adjusting your search or filter criteria</p>
                                    </div>
                                ) : (
                                    communities.map((community, index) => (
                                        <CommunityCard
                                            key={index}
                                            community={community}
                                            index={index}
                                            isExpanded={expandedCards.has(index)}
                                            onToggle={toggleCardExpansion}
                                            isCompact={isCompact}
                                        />
                                    ))
                                )}
                            </div>

                            <Pagination pagination={pagination} />
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(RedditExplorer));
    </script>
</body>
</html>